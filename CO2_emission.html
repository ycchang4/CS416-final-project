<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Emissions Bar Chart</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #chart {
            width: 100%;
            height: 500px;
        }

        .bar {
            fill: steelblue;
            cursor: pointer;
        }

        .bar:hover {
            fill: orange;
        }

        .hidden {
            display: none;
        }

        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    <select id="country-selector">
        <option value="">Select a country</option>
    </select>
    <div id="tooltip" class="hidden"></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Define dimensions and margins
        const margin = { top: 20, right: 20, bottom: 30, left: 40 },
              width = 960 - margin.left - margin.right,
              height = 500 - margin.top - margin.bottom;

        // Create SVG container
        const svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Set up scales and axes
        const x = d3.scaleBand()
            .range([0, width])
            .padding(0.1);

        const y = d3.scaleLinear()
            .range([height, 0]);

        const xAxis = d3.axisBottom(x);
        const yAxis = d3.axisLeft(y);

        // Create tooltip
        const tooltip = d3.select("#tooltip");

        function updateChart(data) {
            // Set domains
            x.domain(data.map(d => d.name));
            y.domain([0, d3.max(data, d => d.co2)]);

            // Remove previous axes and bars
            svg.selectAll(".x-axis").remove();
            svg.selectAll(".y-axis").remove();
            svg.selectAll(".bar").remove();

            // Append x-axis
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            // Append y-axis
            svg.append("g")
                .attr("class", "y-axis")
                .call(yAxis);

            // Append bars
            svg.selectAll(".bar")
                .data(data)
              .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.co2))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.co2))
                .on("mouseover", (event, d) => {
                    tooltip
                        .style("left", `${event.pageX + 5}px`)
                        .style("top", `${event.pageY - 28}px`)
                        .style("display", "inline-block")
                        .html(`Country: ${d.name}<br>CO2: ${d3.format(",")(d.co2)} tonnes<br>Date: ${d.date}<br>Rank: ${d.rank}<br>Region: ${d.region}`);
                })
                .on("mouseout", () => {
                    tooltip.style("display", "none");
                });
        }

        // Load CSV data
        d3.csv("data/carbon_dioxide_emissions.csv").then(data => {
            // Debugging: Check if data is loaded
            console.log("Loaded data:", data);

            data.forEach(d => {
                // Remove commas and convert to number
                d.metric_tonnes_of_CO2 = +d.metric_tonnes_of_CO2;
                d.ranking = +d.ranking; // Convert rank to number
            });

            // Filter top 10 countries
            const top10 = data.filter(d => d.ranking <= 10);
            updateChart(top10);

            // Populate country selector
            const selector = d3.select("#country-selector");
            data.forEach(d => {
                if (d.rank > 10) {
                    selector.append("option")
                        .attr("value", d.slug)
                        .text(d.name);
                }
            });

            // Update chart when a country is selected
            selector.on("change", function() {
                const selectedCountry = this.value;
                if (selectedCountry) {
                    const selectedData = data.find(d => d.slug === selectedCountry);
                    if (selectedData) {
                        updateChart(top10.concat(selectedData));
                    } else {
                        console.error('Selected country not found:', selectedCountry);
                    }
                } else {
                    updateChart(top10);
                }
            });
        }).catch(error => {
            console.error('Error loading or parsing CSV file:', error);
        });
    </script>
</body>
</html>
